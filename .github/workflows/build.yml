name: Build APK

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install buildozer cython virtualenv
        pip install kivy pillow requests
    
    - name: Download model from Release
      run: |
        echo "ğŸ“¥ Downloading model file from GitHub Release..."
        
        # é…ç½®
        VERSION="v1.7.2"
        MODEL_FILE="best_siamese_model.pth"
        DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/${MODEL_FILE}"
        
        # ä¸‹è½½æ¨¡å‹æ–‡ä»¶
        if [ ! -f "${MODEL_FILE}" ]; then
          echo "Downloading from: ${DOWNLOAD_URL}"
          
          # ä½¿ç”¨curlä¸‹è½½ï¼ˆæ”¯æŒé‡å®šå‘ï¼‰
          curl -L -o "${MODEL_FILE}" "${DOWNLOAD_URL}" || {
            echo "âŒ Failed to download from release"
            echo "Trying to download using Python script..."
            python download_model.py || {
              echo "âŒ Python script also failed"
              echo "âš ï¸  Building without model file (app may not work properly)"
            }
          }
          
          # éªŒè¯æ–‡ä»¶
          if [ -f "${MODEL_FILE}" ]; then
            FILE_SIZE=$(stat -c%s "${MODEL_FILE}" 2>/dev/null || stat -f%z "${MODEL_FILE}" 2>/dev/null || echo "0")
            echo "âœ… Model downloaded: ${FILE_SIZE} bytes"
          else
            echo "âš ï¸  Model file not found, continuing anyway..."
          fi
        else
          echo "âœ… Model file already exists"
        fi
    
    - name: Build with Buildozer
      run: |
        # åˆå§‹åŒ–buildozerï¼ˆå¦‚æœéœ€è¦ï¼‰
        buildozer init || true
        
        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        buildozer android clean || true
        
        # æ„å»ºAPK
        buildozer android debug || {
          echo "âš ï¸  Build failed, check logs"
          exit 1
        }
    
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: GrabOrderApp-APK
        path: bin/*.apk
        
    - name: Create Release (if tagged)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          bin/*.apk
        body: |
          ## ğŸ“± GrabOrderApp ${{ github.ref_name }}
          
          ### ğŸš€ Features
          - Nine-grid verification system
          - Automatic order grabbing
          - Real-time logging
          
          ### ğŸ“¥ Installation
          1. Download the APK file
          2. Enable "Unknown Sources" in Android settings
          3. Install the APK
          
          ### âš ï¸ Important
          This APK requires the Siamese model for nine-grid verification.
          The model is automatically included during build.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
