name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: â˜• å®‰è£…Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          autoconf \
          automake \
          libtool \
          libtool-bin \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libffi-dev \
          libssl-dev \
          python3-dev \
          cmake \
          gettext \
          expect
    
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        pip install --upgrade pip
        pip install buildozer cython
    
    - name: ğŸ”§ é…ç½®æ„å»ºç¯å¢ƒ
      run: |
        echo "BUILDOZER_WARN_ON_ROOT=0" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "ACLOCAL_PATH=/usr/share/aclocal" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
        # ç¦ç”¨numpyå°è¯•ç¼–è¯‘libffi
        echo "NPY_DISABLE_SVML=1" >> $GITHUB_ENV
        echo "NPY_BLAS_ORDER=" >> $GITHUB_ENV
        echo "NPY_LAPACK_ORDER=" >> $GITHUB_ENV
    
    - name: ğŸ”¨ æ„å»ºAPK
      run: |
        # è®¾ç½®ä¸ºéäº¤äº’æ¨¡å¼ï¼Œè‡ªåŠ¨æ¥å—è®¸å¯è¯
        export CI=true
        export ACLOCAL_PATH=/usr/share/aclocal
        export PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/share/pkgconfig
        buildozer -v android debug
      env:
        BUILDOZER_WARN_ON_ROOT: 0
        CI: true
        ACLOCAL_PATH: /usr/share/aclocal
        PKG_CONFIG_PATH: /usr/lib/pkgconfig:/usr/share/pkgconfig
    
    - name: ğŸ“¤ ä¸Šä¼ APK
      uses: actions/upload-artifact@v4
      with:
        name: graborder-apk
        path: bin/*.apk
        if-no-files-found: error
    
    - name: ğŸ“Š æ˜¾ç¤ºAPKä¿¡æ¯
      run: |
        echo "âœ… APKæ„å»ºæˆåŠŸï¼"
        ls -lh bin/*.apk

