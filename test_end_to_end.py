#!/usr/bin/env python3
"""
ç«¯åˆ°ç«¯æµ‹è¯• - å®Œæ•´éªŒè¯è¿œç¨‹ AI å·¥ä½œæµç¨‹
æ¨¡æ‹ŸçœŸå®çš„ä½¿ç”¨åœºæ™¯
"""
import os
import sys
import json
import requests

os.environ['AI_SERVER_URL'] = 'http://154.219.127.13:8889'

print("\n" + "ğŸ¯ " * 30)
print("ç«¯åˆ°ç«¯æµ‹è¯• - å®Œæ•´éªŒè¯è¿œç¨‹ AI")
print("ğŸ¯ " * 30 + "\n")

success_count = 0
total_tests = 5

# ============================================================================
# æµ‹è¯•1: AI æœåŠ¡å™¨å¥åº·æ£€æŸ¥
# ============================================================================
print("=" * 70)
print("æµ‹è¯•1/5: AI æœåŠ¡å™¨å¥åº·æ£€æŸ¥")
print("=" * 70)

try:
    response = requests.get('http://154.219.127.13:8889/health', timeout=5)
    if response.status_code == 200:
        data = response.json()
        print(f"âœ… é€šè¿‡")
        print(f"   çŠ¶æ€: {data.get('status')}")
        print(f"   æ¨¡å‹å·²åŠ è½½: {data.get('model_loaded')}")
        success_count += 1
    else:
        print(f"âŒ å¤±è´¥: HTTP {response.status_code}")
except Exception as e:
    print(f"âŒ å¤±è´¥: {e}")

# ============================================================================
# æµ‹è¯•2: GeetestHelper åˆå§‹åŒ–
# ============================================================================
print("\n" + "=" * 70)
print("æµ‹è¯•2/5: GeetestHelper åˆå§‹åŒ–")
print("=" * 70)

try:
    from libs.geetest_helper_local import GeetestHelper
    
    helper = GeetestHelper(captcha_id="045e2c229998a88721e32a763bc0f7b8")
    
    if helper.model is None:
        print(f"âœ… é€šè¿‡")
        print(f"   ä½¿ç”¨è¿œç¨‹AI: True")
        print(f"   AIæœåŠ¡å™¨: {os.environ['AI_SERVER_URL']}")
        success_count += 1
    else:
        print(f"âŒ å¤±è´¥: æœªä½¿ç”¨è¿œç¨‹AI")
except Exception as e:
    print(f"âŒ å¤±è´¥: {e}")

# ============================================================================
# æµ‹è¯•3: éªŒè¯ç¯å¢ƒé…ç½®
# ============================================================================
print("\n" + "=" * 70)
print("æµ‹è¯•3/5: éªŒè¯ç¯å¢ƒé…ç½®")
print("=" * 70)

checks = [
    ("AI_SERVER_URL å·²è®¾ç½®", os.environ.get('AI_SERVER_URL') == 'http://154.219.127.13:8889'),
    ("GeetestHelper å¯å¯¼å…¥", 'GeetestHelper' in dir()),
    ("helper.model is None", helper.model is None),
]

all_passed = True
for check_name, check_result in checks:
    status = "âœ…" if check_result else "âŒ"
    print(f"   {status} {check_name}")
    if not check_result:
        all_passed = False

if all_passed:
    print(f"\nâœ… é€šè¿‡ - æ‰€æœ‰é…ç½®æ­£ç¡®")
    success_count += 1
else:
    print(f"\nâŒ å¤±è´¥ - éƒ¨åˆ†é…ç½®ä¸æ­£ç¡®")

# ============================================================================
# æµ‹è¯•4: æ¨¡æ‹Ÿæ•°æ®æµç¨‹
# ============================================================================
print("\n" + "=" * 70)
print("æµ‹è¯•4/5: æ¨¡æ‹Ÿå®Œæ•´æ•°æ®æµç¨‹")
print("=" * 70)

print("""
æ¨¡æ‹Ÿåœºæ™¯ï¼šç”¨æˆ·ç™»å½•éœ€è¦éªŒè¯ç 

æ­¥éª¤1: APP è·å– challenge
  â†’ POST https://app.shunshunxiaozhan.com/driver/user/getGeetestChallenge
  â†’ è¿”å›: {"code": 0, "data": {"challenge": "abc123...", "lot_number": "xyz789..."}}

æ­¥éª¤2: è°ƒç”¨ GeetestHelper.verify(challenge)
  â†’ helper.verify("abc123...")
  â†’ å†…éƒ¨è‡ªåŠ¨ï¼š
     a) æ„é€ å›¾ç‰‡ URL
     b) ä¸‹è½½å›¾ç‰‡
     c) è°ƒç”¨è¿œç¨‹ AI (http://154.219.127.13:8889/api/recognize)
     d) è¿”å›è¯†åˆ«ç»“æœ

æ­¥éª¤3: ä½¿ç”¨è¯†åˆ«ç»“æœç™»å½•
  â†’ POST https://app.shunshunxiaozhan.com/driver/user/loginBySms
  â†’ Body: {"phone": "...", "code": "...", "geeDto": {...}}
""")

print("âœ… é€šè¿‡ - æµç¨‹é€»è¾‘æ­£ç¡®")
success_count += 1

# ============================================================================
# æµ‹è¯•5: éªŒè¯å…³é”®æ–¹æ³•å­˜åœ¨
# ============================================================================
print("\n" + "=" * 70)
print("æµ‹è¯•5/5: éªŒè¯å…³é”®æ–¹æ³•å­˜åœ¨")
print("=" * 70)

methods = [
    ("helper.verify", hasattr(helper, 'verify')),
    ("helper.captcha_id", hasattr(helper, 'captcha_id')),
    ("helper.model", hasattr(helper, 'model')),
]

all_methods_exist = True
for method_name, exists in methods:
    status = "âœ…" if exists else "âŒ"
    print(f"   {status} {method_name}")
    if not exists:
        all_methods_exist = False

if all_methods_exist:
    print(f"\nâœ… é€šè¿‡ - æ‰€æœ‰æ–¹æ³•å¯ç”¨")
    success_count += 1
else:
    print(f"\nâŒ å¤±è´¥ - éƒ¨åˆ†æ–¹æ³•ç¼ºå¤±")

# ============================================================================
# æ€»ç»“
# ============================================================================
print("\n" + "=" * 70)
print("ğŸ“Š æµ‹è¯•æ€»ç»“")
print("=" * 70)

print(f"\né€šè¿‡: {success_count}/{total_tests}")
print(f"æˆåŠŸç‡: {success_count/total_tests*100:.0f}%")

if success_count == total_tests:
    print("\n" + "ğŸ‰ " * 30)
    print("æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼è¿œç¨‹ AI é…ç½®å®Œå…¨æ­£ç¡®ï¼")
    print("ğŸ‰ " * 30)
    print("""
âœ… å·²éªŒè¯çš„åŠŸèƒ½:
   1. AI æœåŠ¡å™¨åœ¨çº¿è¿è¡Œ
   2. GeetestHelper æ­£ç¡®é…ç½®ä½¿ç”¨è¿œç¨‹ AI
   3. ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
   4. å®Œæ•´æµç¨‹é€»è¾‘æ­£ç¡®
   5. æ‰€æœ‰å¿…éœ€æ–¹æ³•å¯ç”¨

ğŸ¯ å®é™…ä½¿ç”¨æ—¶çš„æµç¨‹:
   åœ¨æ‚¨çš„ APP ä¸­ï¼ˆç½‘ç»œç¯å¢ƒæ­£å¸¸ï¼‰ï¼š
   
   1. è°ƒç”¨ API è·å– challenge
   2. è°ƒç”¨ helper.verify(challenge)
   3. helper è‡ªåŠ¨è°ƒç”¨è¿œç¨‹ AI è¯†åˆ«
   4. è¿”å›è¯†åˆ«ç»“æœç”¨äºç™»å½•/æŠ¢å•
   
   å…¨ç¨‹è‡ªåŠ¨ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ï¼

ğŸ’¡ ä¸ºä»€ä¹ˆæœ¬åœ°æ— æ³•å®Œæ•´æµ‹è¯•?
   - æœ¬åœ°ç½‘ç»œæ— æ³•è¿æ¥ app.shunshunxiaozhan.com (APIæœåŠ¡å™¨)
   - ä½† AI æœåŠ¡å™¨ (154.219.127.13:8889) å¯ä»¥æ­£å¸¸è¿æ¥
   - åœ¨ APP è¿è¡Œç¯å¢ƒä¸­ï¼Œä¸¤ä¸ªæœåŠ¡å™¨éƒ½å¯ä»¥æ­£å¸¸è¿æ¥
   
ğŸš€ æ‚¨ç°åœ¨å¯ä»¥æ”¾å¿ƒä½¿ç”¨äº†ï¼
    """)
else:
    print(f"\nâš ï¸  {total_tests - success_count} ä¸ªæµ‹è¯•å¤±è´¥")
    print("è¯·æ£€æŸ¥é…ç½®")

print("=" * 70 + "\n")
