# ç®€åŒ–ç‰ˆVPNæŠ¢å•åº”ç”¨æ¨¡æ¿

## ğŸ“‹ é¡¹ç›®ç»“æ„

```
grab_order_app/
â”œâ”€â”€ main.py                 # åº”ç”¨å…¥å£ï¼ˆç®€åŒ–ç‰ˆï¼‰
â”œâ”€â”€ buildozer.spec          # Buildozeré…ç½®
â”œâ”€â”€ requirements.txt        # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ vpn/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ vpn_service.py  # VPNæœåŠ¡
â”‚   â”œâ”€â”€ grab/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ grab_service.py # æŠ¢å•æœåŠ¡
â”‚   â””â”€â”€ config/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ config.py       # é…ç½®ç®¡ç†
â””â”€â”€ assets/
    â””â”€â”€ fonts/
        â””â”€â”€ DroidSansFallback.ttf
```

## ğŸš€ æœ€å°åŒ–å¯å·¥ä½œç‰ˆæœ¬

### main.py (ç®€åŒ–ç‰ˆ)

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
VPNæŠ¢å•åŠ©æ‰‹ - ç®€åŒ–ç‰ˆ
"""

import os
import sys
from kivy.app import App
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.button import Button
from kivy.uix.label import Label
from kivy.uix.textinput import TextInput
from kivy.clock import Clock
from kivy.core.text import LabelBase

# Androidç¯å¢ƒæ£€æµ‹
try:
    from android.permissions import request_permissions, Permission
    ANDROID = True
except ImportError:
    ANDROID = False

# å¯¼å…¥ä¸šåŠ¡æ¨¡å—
try:
    from src.vpn.vpn_service import VPNService
    from src.grab.grab_service import GrabService
    from src.config.config import Config
except ImportError as e:
    print(f"æ¨¡å—å¯¼å…¥å¤±è´¥: {e}")
    VPNService = None
    GrabService = None
    Config = None


class MainScreen(BoxLayout):
    """ä¸»ç•Œé¢"""
    
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.orientation = 'vertical'
        self.padding = 20
        self.spacing = 10
        
        # åˆå§‹åŒ–é…ç½®
        self.config = Config() if Config else None
        
        # åˆå§‹åŒ–æœåŠ¡
        self.vpn_service = VPNService(self.config) if VPNService else None
        self.grab_service = GrabService(self.config) if GrabService else None
        
        # æ„å»ºUI
        self.build_ui()
        
        # å®šæ—¶æ›´æ–°
        Clock.schedule_interval(self.update_status, 1.0)
    
    def build_ui(self):
        """æ„å»ºUI"""
        # æ ‡é¢˜
        title = Label(
            text='VPNæŠ¢å•åŠ©æ‰‹',
            size_hint_y=0.1,
            font_size='24sp'
        )
        self.add_widget(title)
        
        # Tokenæ˜¾ç¤º
        self.token_label = Label(
            text='Token: æœªè·å–',
            size_hint_y=0.1,
            text_size=(None, None),
            halign='left'
        )
        self.add_widget(self.token_label)
        
        # ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        self.user_label = Label(
            text='UserID: æœªè·å–',
            size_hint_y=0.1,
            text_size=(None, None),
            halign='left'
        )
        self.add_widget(self.user_label)
        
        # æ§åˆ¶æŒ‰é’®
        btn_layout = BoxLayout(size_hint_y=0.15, spacing=10)
        
        self.vpn_btn = Button(
            text='å¯åŠ¨VPN',
            on_press=self.toggle_vpn
        )
        btn_layout.add_widget(self.vpn_btn)
        
        self.grab_btn = Button(
            text='å¼€å§‹æŠ¢å•',
            on_press=self.toggle_grab,
            disabled=True
        )
        btn_layout.add_widget(self.grab_btn)
        
        self.add_widget(btn_layout)
        
        # çŠ¶æ€æ˜¾ç¤º
        self.status_label = Label(
            text='çŠ¶æ€: æœªå¯åŠ¨',
            size_hint_y=0.3,
            text_size=(None, None),
            halign='left',
            valign='top'
        )
        self.add_widget(self.status_label)
    
    def toggle_vpn(self, instance):
        """åˆ‡æ¢VPNçŠ¶æ€"""
        if self.vpn_service:
            if self.vpn_service.is_running:
                self.vpn_service.stop()
                instance.text = 'å¯åŠ¨VPN'
                self.grab_btn.disabled = True
            else:
                if self.vpn_service.start():
                    instance.text = 'åœæ­¢VPN'
                    self.grab_btn.disabled = False
                else:
                    self.update_status_label('VPNå¯åŠ¨å¤±è´¥')
    
    def toggle_grab(self, instance):
        """åˆ‡æ¢æŠ¢å•çŠ¶æ€"""
        if self.grab_service:
            if self.grab_service.is_running:
                self.grab_service.stop()
                instance.text = 'å¼€å§‹æŠ¢å•'
            else:
                self.grab_service.start()
                instance.text = 'åœæ­¢æŠ¢å•'
    
    def update_status(self, dt):
        """æ›´æ–°çŠ¶æ€"""
        if self.config:
            token = self.config.get_token()
            userid = self.config.get_userid()
            clubid = self.config.get_clubid()
            
            if token:
                self.token_label.text = f'Token: {token[:20]}...'
            if userid:
                self.user_label.text = f'UserID: {userid} | ClubID: {clubid}'
        
        # æ›´æ–°æœåŠ¡çŠ¶æ€
        if self.vpn_service and self.vpn_service.is_running:
            self.status_label.text = 'çŠ¶æ€: VPNè¿è¡Œä¸­\næ­£åœ¨ç›‘æ§ç½‘ç»œæµé‡...'
        elif self.grab_service and self.grab_service.is_running:
            self.status_label.text = 'çŠ¶æ€: æŠ¢å•è¿è¡Œä¸­\næ­£åœ¨ç›‘æ§è®¢å•...'
        else:
            self.status_label.text = 'çŠ¶æ€: æœªå¯åŠ¨'
    
    def update_status_label(self, message):
        """æ›´æ–°çŠ¶æ€æ ‡ç­¾"""
        self.status_label.text = message


class GrabOrderApp(App):
    """ä¸»åº”ç”¨"""
    
    def build(self):
        """æ„å»ºåº”ç”¨"""
        # è¯·æ±‚Androidæƒé™
        if ANDROID:
            permissions = [
                Permission.INTERNET,
                Permission.ACCESS_NETWORK_STATE,
                Permission.BIND_VPN_SERVICE,
            ]
            request_permissions(permissions)
        
        # æ³¨å†Œå­—ä½“
        self.register_fonts()
        
        return MainScreen()
    
    def register_fonts(self):
        """æ³¨å†Œä¸­æ–‡å­—ä½“"""
        if ANDROID:
            font_paths = [
                'fonts/DroidSansFallback.ttf',
                './fonts/DroidSansFallback.ttf',
            ]
            for font_path in font_paths:
                if os.path.exists(font_path):
                    try:
                        LabelBase.register(
                            name='DroidSansFallback',
                            fn_regular=font_path
                        )
                        break
                    except:
                        continue


if __name__ == '__main__':
    GrabOrderApp().run()
```

### src/vpn/vpn_service.py

```python
# -*- coding: utf-8 -*-
"""
VPNæœåŠ¡ - ç®€åŒ–ç‰ˆ
"""

import threading
import socket
import struct

try:
    from jnius import autoclass
    from android import mActivity
    ANDROID = True
except ImportError:
    ANDROID = False


class VPNService:
    """VPNæœåŠ¡"""
    
    def __init__(self, config):
        self.config = config
        self.is_running = False
        self.vpn_interface = None
        self.capture_thread = None
        
        if ANDROID:
            self.VpnService = autoclass('android.net.VpnService')
            self.Builder = autoclass('android.net.VpnService$Builder')
            self.Intent = autoclass('android.content.Intent')
    
    def start(self):
        """å¯åŠ¨VPN"""
        if not ANDROID:
            print("éAndroidç¯å¢ƒï¼ŒVPNä¸å¯ç”¨")
            return False
        
        try:
            # è¯·æ±‚VPNæƒé™
            intent = self.VpnService.prepare(mActivity)
            if intent:
                mActivity.startActivityForResult(intent, 0)
                return False
            
            # åˆ›å»ºVPNæ¥å£
            builder = self.VpnService.Builder()
            builder.setSession("VPNæŠ¢å•åŠ©æ‰‹")
            builder.addAddress("10.0.0.2", 30)
            builder.addRoute("0.0.0.0", 0)
            
            self.vpn_interface = builder.establish()
            if not self.vpn_interface:
                return False
            
            # å¯åŠ¨æŠ“åŒ…çº¿ç¨‹
            self.is_running = True
            self.capture_thread = threading.Thread(target=self._capture_packets)
            self.capture_thread.start()
            
            return True
        except Exception as e:
            print(f"VPNå¯åŠ¨å¤±è´¥: {e}")
            return False
    
    def stop(self):
        """åœæ­¢VPN"""
        self.is_running = False
        if self.vpn_interface:
            try:
                self.vpn_interface.close()
            except:
                pass
            self.vpn_interface = None
    
    def _capture_packets(self):
        """æ•è·æ•°æ®åŒ…"""
        if not self.vpn_interface:
            return
        
        try:
            file_descriptor = self.vpn_interface.getFileDescriptor()
            file_input = os.fdopen(file_descriptor, 'rb')
            
            while self.is_running:
                # è¯»å–æ•°æ®åŒ…
                packet = file_input.read(4096)
                if not packet:
                    break
                
                # è§£ææ•°æ®åŒ…
                self._parse_packet(packet)
        except Exception as e:
            print(f"æŠ“åŒ…å‡ºé”™: {e}")
    
    def _parse_packet(self, packet):
        """è§£ææ•°æ®åŒ…"""
        try:
            # è§£æIPå¤´
            if len(packet) < 20:
                return
            
            # æå–åè®®ç±»å‹
            protocol = packet[9]
            
            # å¦‚æœæ˜¯TCP
            if protocol == 6:
                self._parse_tcp(packet)
        except Exception as e:
            pass
    
    def _parse_tcp(self, packet):
        """è§£æTCPæ•°æ®åŒ…"""
        try:
            # æå–TCPæ•°æ®
            ip_header_length = (packet[0] & 0x0F) * 4
            tcp_header_length = (packet[ip_header_length + 12] >> 4) * 4
            data_start = ip_header_length + tcp_header_length
            
            if len(packet) <= data_start:
                return
            
            data = packet[data_start:]
            
            # è§£æHTTPè¯·æ±‚
            if b'Authorization' in data or b'authorization' in data:
                self._extract_token(data)
        except Exception as e:
            pass
    
    def _extract_token(self, data):
        """æå–Token"""
        try:
            data_str = data.decode('utf-8', errors='ignore')
            
            # æå–Authorization token
            if 'Authorization:' in data_str:
                lines = data_str.split('\n')
                for line in lines:
                    if 'Authorization:' in line:
                        token = line.split('Authorization:')[1].strip()
                        if self.config:
                            self.config.update_token(token)
                        break
        except Exception as e:
            pass
```

### src/grab/grab_service.py

```python
# -*- coding: utf-8 -*-
"""
æŠ¢å•æœåŠ¡ - ç®€åŒ–ç‰ˆ
"""

import threading
import time
import requests


class GrabService:
    """æŠ¢å•æœåŠ¡"""
    
    def __init__(self, config):
        self.config = config
        self.is_running = False
        self.monitor_thread = None
    
    def start(self):
        """å¼€å§‹æŠ¢å•"""
        if self.is_running:
            return
        
        self.is_running = True
        self.monitor_thread = threading.Thread(target=self._monitor_orders)
        self.monitor_thread.start()
    
    def stop(self):
        """åœæ­¢æŠ¢å•"""
        self.is_running = False
        if self.monitor_thread:
            self.monitor_thread.join(timeout=2)
    
    def _monitor_orders(self):
        """ç›‘æ§è®¢å•"""
        while self.is_running:
            try:
                # è·å–è®¢å•åˆ—è¡¨
                orders = self._get_orders()
                
                # æŠ¢å•
                for order in orders:
                    if self._should_grab(order):
                        self._grab_order(order)
                
                # ç­‰å¾…é—´éš”
                time.sleep(1)
            except Exception as e:
                print(f"ç›‘æ§è®¢å•å‡ºé”™: {e}")
                time.sleep(5)
    
    def _get_orders(self):
        """è·å–è®¢å•åˆ—è¡¨"""
        if not self.config:
            return []
        
        try:
            headers = {
                'Authorization': f'Bearer {self.config.get_token()}',
                'User-Id': self.config.get_userid() or '',
                'Club-Id': self.config.get_clubid() or ''
            }
            
            # æ›¿æ¢ä¸ºå®é™…çš„APIåœ°å€
            response = requests.get(
                'https://api.example.com/orders',
                headers=headers,
                timeout=5
            )
            
            if response.status_code == 200:
                return response.json().get('data', [])
        except Exception as e:
            print(f"è·å–è®¢å•å¤±è´¥: {e}")
        
        return []
    
    def _should_grab(self, order):
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥æŠ¢å•"""
        # å®ç°æŠ¢å•ç­–ç•¥
        return True
    
    def _grab_order(self, order):
        """æŠ¢å•"""
        if not self.config:
            return False
        
        try:
            headers = {
                'Authorization': f'Bearer {self.config.get_token()}',
                'User-Id': self.config.get_userid() or '',
                'Club-Id': self.config.get_clubid() or ''
            }
            
            # æ›¿æ¢ä¸ºå®é™…çš„APIåœ°å€
            response = requests.post(
                f'https://api.example.com/orders/{order["id"]}/grab',
                headers=headers,
                timeout=5
            )
            
            return response.status_code == 200
        except Exception as e:
            print(f"æŠ¢å•å¤±è´¥: {e}")
            return False
```

### src/config/config.py

```python
# -*- coding: utf-8 -*-
"""
é…ç½®ç®¡ç† - ç®€åŒ–ç‰ˆ
"""

import json
import os
import threading


class Config:
    """é…ç½®ç®¡ç†"""
    
    def __init__(self, config_file='config.json'):
        self.config_file = config_file
        self._lock = threading.Lock()
        self._data = {
            'token': None,
            'userid': None,
            'clubid': None
        }
        self.load()
    
    def load(self):
        """åŠ è½½é…ç½®"""
        if os.path.exists(self.config_file):
            try:
                with open(self.config_file, 'r') as f:
                    self._data = json.load(f)
            except:
                pass
    
    def save(self):
        """ä¿å­˜é…ç½®"""
        try:
            with open(self.config_file, 'w') as f:
                json.dump(self._data, f)
        except:
            pass
    
    def get_token(self):
        """è·å–Token"""
        with self._lock:
            return self._data.get('token')
    
    def get_userid(self):
        """è·å–UserID"""
        with self._lock:
            return self._data.get('userid')
    
    def get_clubid(self):
        """è·å–ClubID"""
        with self._lock:
            return self._data.get('clubid')
    
    def update_token(self, token, userid=None, clubid=None):
        """æ›´æ–°Tokenå’Œç”¨æˆ·ä¿¡æ¯"""
        with self._lock:
            self._data['token'] = token
            if userid:
                self._data['userid'] = userid
            if clubid:
                self._data['clubid'] = clubid
            self.save()
```

### buildozer.spec (ç®€åŒ–ç‰ˆ)

```ini
[app]
title = VPNæŠ¢å•åŠ©æ‰‹
package.name = graborder
package.domain = com.graborder
source.dir = .
source.include_exts = py,png,jpg,kv,atlas,ttf
version = 0.1
requirements = python3,kivy,requests,pyjnius,android

[buildozer]
log_level = 2
```

## ğŸš€ ä½¿ç”¨è¯´æ˜

1. **åˆ›å»ºé¡¹ç›®ç»“æ„**ï¼š
   ```bash
   mkdir -p grab_order_app/src/{vpn,grab,config}
   mkdir -p grab_order_app/assets/fonts
   ```

2. **å¤åˆ¶æ–‡ä»¶**ï¼šå°†ä¸Šè¿°ä»£ç ä¿å­˜åˆ°å¯¹åº”æ–‡ä»¶

3. **å®‰è£…ä¾èµ–**ï¼š
   ```bash
   pip install kivy requests
   ```

4. **æµ‹è¯•è¿è¡Œ**ï¼š
   ```bash
   python main.py
   ```

5. **æ‰“åŒ…APK**ï¼š
   ```bash
   buildozer android debug
   ```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **VPNåŠŸèƒ½**ï¼šéœ€è¦åœ¨Androidè®¾å¤‡ä¸Šæµ‹è¯•ï¼ŒPCç¯å¢ƒæ— æ³•ä½¿ç”¨
2. **APIåœ°å€**ï¼šéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„APIåœ°å€
3. **æƒé™**ï¼šéœ€è¦åœ¨AndroidManifest.xmlä¸­æ·»åŠ VPNæƒé™
4. **Tokenæå–**ï¼šéœ€è¦æ ¹æ®å®é™…ç½‘ç»œåè®®è°ƒæ•´è§£æé€»è¾‘

## ğŸ”§ æ‰©å±•åŠŸèƒ½

1. **æ·»åŠ Geetestè¯†åˆ«**ï¼šé›†æˆéªŒè¯ç è¯†åˆ«
2. **æ·»åŠ è®¢å•ç­›é€‰**ï¼šå®ç°æ›´æ™ºèƒ½çš„æŠ¢å•ç­–ç•¥
3. **æ·»åŠ æ—¥å¿—ç³»ç»Ÿ**ï¼šè®°å½•æŠ¢å•æ—¥å¿—
4. **æ·»åŠ é…ç½®ç•Œé¢**ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰é…ç½®

