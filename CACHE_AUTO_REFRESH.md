# ç¼“å­˜è‡ªåŠ¨åˆ·æ–°æœºåˆ¶è¯¦è§£

## å·¥ä½œæµç¨‹å›¾

```
å¯åŠ¨APP
  â†“
åˆå§‹åŒ–Geetest
  â†“
åå°å¯åŠ¨10ä¸ªçº¿ç¨‹å¹¶å‘é¢„åŠ è½½
  â”œâ”€ çº¿ç¨‹1: è°ƒç”¨AIè·å–éªŒè¯1 (2ç§’) â†’ åŠ å…¥é˜Ÿåˆ—
  â”œâ”€ çº¿ç¨‹2: è°ƒç”¨AIè·å–éªŒè¯2 (2ç§’) â†’ åŠ å…¥é˜Ÿåˆ—
  â”œâ”€ ...
  â””â”€ çº¿ç¨‹10: è°ƒç”¨AIè·å–éªŒè¯10 (2ç§’) â†’ åŠ å…¥é˜Ÿåˆ—
  â†“
ç¼“å­˜é˜Ÿåˆ—: [éªŒè¯1, éªŒè¯2, ..., éªŒè¯10]
  â†“
ä¸»çº¿ç¨‹å¼€å§‹æ£€æµ‹è®¢å•ï¼ˆæ¯100msï¼‰
  â†“
å‘ç°è®¢å• â†’ æŠ¢å•
  â†“
ä»ç¼“å­˜å–å‡ºéªŒè¯1 (age: 5ç§’)
  â†“
âœ… ä½¿ç”¨éªŒè¯1å‘é€æŠ¢å•è¯·æ±‚
  â†“
ğŸ”„ åŒæ—¶è§¦å‘ï¼šåå°è¡¥å……æ–°éªŒè¯ (å¼‚æ­¥)
  â†“
ç¼“å­˜é˜Ÿåˆ—: [éªŒè¯2, éªŒè¯3, ..., éªŒè¯10, (éªŒè¯11åŠ è½½ä¸­...)]
  â†“
ç»§ç»­æ£€æµ‹...
  â†“
åˆå‘ç°è®¢å• â†’ ä»ç¼“å­˜å–éªŒè¯2 â†’ è§¦å‘è¡¥å……...
  â†“
å¾ªç¯å¾€å¤ï¼Œç¼“å­˜ä¸€ç›´ä¿æŒ10-20ä¸ª
```

## æ ¸å¿ƒä»£ç 

### 1. å¯åŠ¨æ—¶é¢„åŠ è½½

```python
def start(self):
    # åˆå§‹åŒ–Geetest
    self._init_geetest()
    
    # å¯åŠ¨é¢„åŠ è½½ï¼ˆåå°ï¼‰
    preload_count = 10  # ç§’æŠ¢æ¨¡å¼
    for _ in range(preload_count):
        # å¼‚æ­¥æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
        self.executor.submit(self._preload_verification)
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨çº¿ç¨‹æ± ï¼ˆ20ä¸ªworkerï¼‰
- 10ä¸ªä»»åŠ¡å¹¶å‘æ‰§è¡Œ
- ä¸é˜»å¡ä¸»çº¿ç¨‹
- çº¦2-3ç§’å®Œæˆåˆå§‹åŠ è½½

### 2. åå°é¢„åŠ è½½å‡½æ•°

```python
def _preload_verification(self):
    """åå°é¢„åŠ è½½éªŒè¯ç ï¼ˆæå‰å‡†å¤‡ï¼‰"""
    
    # æ£€æŸ¥ç¼“å­˜æ˜¯å¦å·²æ»¡
    if len(self.verification_queue) >= self.max_cache_size:
        return  # å·²æ»¡ï¼ˆ20ä¸ªï¼‰ï¼Œåœæ­¢åŠ è½½
    
    # è°ƒç”¨AIæœåŠ¡å™¨è·å–éªŒè¯
    if hasattr(self, 'geetest_helper') and self.geetest_helper:
        challenge = str(uuid.uuid4())
        
        # å¼‚æ­¥è·å–éªŒè¯ï¼ˆä¸é˜»å¡ï¼‰
        future = self.executor.submit(
            self.geetest_helper.verify,
            challenge=challenge
        )
        
        # å®šä¹‰å›è°ƒï¼šæˆåŠŸååŠ å…¥ç¼“å­˜
        def cache_result(f):
            try:
                result = f.result(timeout=5)  # ç­‰å¾…ç»“æœ
                if result and result.get('success'):
                    # åŠ å…¥ç¼“å­˜é˜Ÿåˆ—
                    self.verification_queue.append({
                        'result': result,
                        'time': time.time()  # è®°å½•åˆ›å»ºæ—¶é—´
                    })
                    # æ‰“å°æ—¥å¿—
                    self.log(f"[CACHE] é¢„åŠ è½½éªŒè¯ {len(self.verification_queue)}/{self.max_cache_size}")
            except:
                pass  # å¤±è´¥å¿½ç•¥
        
        # ç»‘å®šå›è°ƒ
        future.add_done_callback(cache_result)
```

**å…³é”®ç‚¹**ï¼š
- âœ… å¼‚æ­¥éé˜»å¡
- âœ… è‡ªåŠ¨å›è°ƒåŠ å…¥é˜Ÿåˆ—
- âœ… è®°å½•æ—¶é—´æˆ³ï¼ˆç”¨äºTTLæ£€æŸ¥ï¼‰
- âœ… é™åˆ¶æœ€å¤§æ•°é‡ï¼ˆ20ä¸ªï¼‰

### 3. ä½¿ç”¨æ—¶è‡ªåŠ¨è¡¥å……

```python
def _get_cached_verification(self):
    """è·å–ç¼“å­˜çš„éªŒè¯ï¼ˆå¦‚æœæœ‰ï¼‰"""
    if self.verification_queue:
        # æ£€æŸ¥æœ€è€çš„æ˜¯å¦è¿‡æœŸ
        age = time.time() - self.verification_queue[0]['time']
        
        if age < self.verification_ttl:  # 90ç§’å†…æœ‰æ•ˆ
            # å–å‡ºä¸€ä¸ªï¼ˆFIFOé˜Ÿåˆ—ï¼‰
            cached = self.verification_queue.pop(0)
            
            self.log(f"[VERIFY] ä½¿ç”¨ç¼“å­˜éªŒè¯ âš¡ (age: {age:.1f}s)", force=True)
            
            # ğŸ”„ å…³é”®ï¼šç«‹å³è§¦å‘è¡¥å……
            self.executor.submit(self._preload_verification)
            
            return cached['result']
        else:
            # è¿‡æœŸäº†ï¼Œç§»é™¤å¹¶æ£€æŸ¥ä¸‹ä¸€ä¸ª
            self.log(f"[VERIFY] ç¼“å­˜è¿‡æœŸ ({age:.1f}s > {self.verification_ttl}s)")
            self.verification_queue.pop(0)
            return self._get_cached_verification()  # é€’å½’
    
    return None  # ç¼“å­˜ç©º
```

**åˆ·æ–°é€»è¾‘**ï¼š
```
ä½¿ç”¨1ä¸ª â†’ ç«‹å³å¼‚æ­¥è¡¥å……1ä¸ª
ä¿æŒç¼“å­˜æ•°é‡ç¨³å®š
```

## åˆ·æ–°ç­–ç•¥

### ç­–ç•¥1ï¼šè¢«åŠ¨è¡¥å……ï¼ˆå½“å‰å®ç°ï¼‰âœ…

```python
# ç”¨ä¸€ä¸ªè¡¥ä¸€ä¸ª
ä½¿ç”¨ç¼“å­˜ â†’ è§¦å‘ self.executor.submit(self._preload_verification)
```

**ä¼˜ç‚¹**ï¼š
- âœ… æŒ‰éœ€è¡¥å……ï¼Œä¸æµªè´¹
- âœ… ç¼“å­˜é‡ç¨³å®š
- âœ… ä»£ç ç®€å•

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¦‚æœä½¿ç”¨å¤ªå¿«ï¼Œå¯èƒ½è€—å°½ç¼“å­˜

### ç­–ç•¥2ï¼šä¸»åŠ¨è¡¥å……ï¼ˆå¯é€‰å¢å¼ºï¼‰

```python
def _background_refill(self):
    """åå°æŒç»­ç›‘æ§å¹¶è¡¥å……ç¼“å­˜"""
    while self.running:
        if len(self.verification_queue) < 10:
            # ç¼“å­˜å°‘äº10ä¸ªï¼Œè¡¥å……åˆ°15ä¸ª
            for _ in range(5):
                self.executor.submit(self._preload_verification)
        time.sleep(5)  # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸»åŠ¨ä¿æŒç¼“å­˜å……è¶³
- âœ… é€‚åˆé«˜é¢‘æŠ¢å•

**ç¼ºç‚¹**ï¼š
- âŒ é¢å¤–çº¿ç¨‹
- âŒ å¯èƒ½æµªè´¹ï¼ˆç¼“å­˜è¿‡æœŸï¼‰

## ç¼“å­˜æ•°é‡å˜åŒ–ç¤ºä¾‹

```
æ—¶é—´è½´ | ç¼“å­˜æ•°é‡ | äº‹ä»¶
------|---------|-----
00:00 | 0       | å¯åŠ¨
00:02 | 3       | 3ä¸ªåŠ è½½å®Œæˆ
00:03 | 7       | 7ä¸ªåŠ è½½å®Œæˆ
00:04 | 10      | å…¨éƒ¨10ä¸ªå®Œæˆ â† åˆå§‹é¢„åŠ è½½å®Œæˆ
00:05 | 9       | ä½¿ç”¨1ä¸ª â†’ è§¦å‘è¡¥å……
00:06 | 10      | è¡¥å……å®Œæˆ
00:07 | 9       | ä½¿ç”¨1ä¸ª â†’ è§¦å‘è¡¥å……
00:08 | 10      | è¡¥å……å®Œæˆ
...   | 9-10    | ç¨³æ€è¿è¡Œï¼ˆç”¨1è¡¥1ï¼‰
```

## æç«¯æƒ…å†µå¤„ç†

### æƒ…å†µ1ï¼šå¿«é€Ÿè¿ç»­æŠ¢å•

```python
# å‡è®¾1ç§’å†…æŠ¢5ä¸ªè®¢å•
æŠ¢å•1 â†’ ç”¨ç¼“å­˜1 â†’ è§¦å‘è¡¥å……ï¼ˆ2ç§’åå®Œæˆï¼‰
æŠ¢å•2 â†’ ç”¨ç¼“å­˜2 â†’ è§¦å‘è¡¥å……ï¼ˆ2ç§’åå®Œæˆï¼‰
æŠ¢å•3 â†’ ç”¨ç¼“å­˜3 â†’ è§¦å‘è¡¥å……ï¼ˆ2ç§’åå®Œæˆï¼‰
æŠ¢å•4 â†’ ç”¨ç¼“å­˜4 â†’ è§¦å‘è¡¥å……ï¼ˆ2ç§’åå®Œæˆï¼‰
æŠ¢å•5 â†’ ç”¨ç¼“å­˜5 â†’ è§¦å‘è¡¥å……ï¼ˆ2ç§’åå®Œæˆï¼‰

å‰©ä½™ç¼“å­˜: 5ä¸ªï¼ˆ10-5=5ï¼‰
2ç§’å: è¡¥å……5ä¸ªï¼Œæ¢å¤åˆ°10ä¸ª
```

**ç»“è®º**ï¼š
- åˆå§‹10ä¸ªç¼“å­˜å¯ä»¥æ”¯æ’‘10æ¬¡æŠ¢å•
- æ¯æ¬¡æŠ¢å•é—´éš”>2ç§’æ—¶ï¼Œç¼“å­˜æ°¸è¿œå……è¶³
- å³ä½¿1ç§’5æ¬¡ï¼Œä¹Ÿèƒ½æ”¯æ’‘2-3ç§’

### æƒ…å†µ2ï¼šç¼“å­˜è€—å°½

```python
if not self.verification_queue:
    # ç¼“å­˜ç©ºï¼Œå›é€€åˆ°å®æ—¶è·å–
    self.log("[VERIFY] ç¼“å­˜ç©ºï¼Œå®æ—¶è·å–éªŒè¯...")
    geetest_result = self.geetest_helper.verify(challenge=challenge)
```

**ä¿åº•æªæ–½**ï¼š
- ç¼“å­˜ç©ºæ—¶ä¸ä¼šå¤±è´¥
- è‡ªåŠ¨é™çº§åˆ°å®æ—¶è·å–
- è™½ç„¶æ…¢ï¼ˆ2ç§’ï¼‰ï¼Œä½†èƒ½æˆåŠŸ

## æ€§èƒ½ç»Ÿè®¡

### ç¼“å­˜å‘½ä¸­åœºæ™¯

```
è®¢å•å‡ºç° â†’ æ£€æµ‹(100ms) â†’ å–ç¼“å­˜(0ms) â†’ å‘é€è¯·æ±‚(300ms)
æ€»è€—æ—¶: 400ms âš¡
```

### ç¼“å­˜æœªå‘½ä¸­åœºæ™¯

```
è®¢å•å‡ºç° â†’ æ£€æµ‹(100ms) â†’ å®æ—¶è·å–(2000ms) â†’ å‘é€è¯·æ±‚(300ms)
æ€»è€—æ—¶: 2400ms âŒ
```

### å®é™…ç»Ÿè®¡ï¼ˆå‡è®¾ï¼‰

```
æ€»æŠ¢å•æ¬¡æ•°: 100æ¬¡
ç¼“å­˜å‘½ä¸­: 80æ¬¡ (400ms)
ç¼“å­˜æœªå‘½ä¸­: 20æ¬¡ (2400ms)

å¹³å‡è€—æ—¶: (80Ã—400 + 20Ã—2400) / 100 = 800ms
æ¯”æ— ç¼“å­˜(2400ms)å¿«3å€
```

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹ç¼“å­˜çŠ¶æ€

```python
# æ·»åŠ çŠ¶æ€æŸ¥è¯¢æ–¹æ³•
def get_cache_status(self):
    return {
        'size': len(self.verification_queue),
        'max_size': self.max_cache_size,
        'oldest_age': time.time() - self.verification_queue[0]['time'] if self.verification_queue else 0,
        'ttl': self.verification_ttl
    }
```

### æ—¥å¿—è¾“å‡º

```
[CACHE] é¢„åŠ è½½éªŒè¯ 5/20     â† å½“å‰5ä¸ªï¼Œæœ€å¤š20ä¸ª
[VERIFY] ä½¿ç”¨ç¼“å­˜éªŒè¯ âš¡ (age: 15.2s)  â† ä½¿ç”¨äº†15ç§’å‰çš„
[VERIFY] ç¼“å­˜è¿‡æœŸ (95s > 90s)  â† å‘ç°è¿‡æœŸçš„
```

## ä¼˜åŒ–å»ºè®®

### å½“å‰é…ç½®ï¼ˆå·²ä¼˜åŒ–ï¼‰âœ…

```python
max_cache_size = 20        # ç¼“å­˜20ä¸ª
verification_ttl = 90      # 90ç§’æœ‰æ•ˆ
preload_count = 10         # å¯åŠ¨åŠ è½½10ä¸ª
max_workers = 20           # 20ä¸ªçº¿ç¨‹
```

### å¦‚æœç¼“å­˜ç»å¸¸ä¸è¶³

```python
# å¢åŠ åˆå§‹é¢„åŠ è½½æ•°é‡
preload_count = 15  # æ”¹ä¸º15ä¸ª

# æˆ–å¢åŠ æœ€å¤§ç¼“å­˜
max_cache_size = 30  # æ”¹ä¸º30ä¸ª
```

### å¦‚æœç¼“å­˜ç»å¸¸è¿‡æœŸ

```python
# å‡å°‘TTL
verification_ttl = 60  # æ”¹ä¸º60ç§’

# æˆ–å¢åŠ åˆ·æ–°é¢‘ç‡ï¼ˆå®ç°ä¸»åŠ¨è¡¥å……ï¼‰
```

## æ€»ç»“

âœ… **è‡ªåŠ¨åˆ·æ–°å·²å®ç°**ï¼š
- å¯åŠ¨é¢„åŠ è½½10ä¸ª
- ä½¿ç”¨æ—¶è‡ªåŠ¨è¡¥å……
- ä¿æŒç¼“å­˜å……è¶³

âœ… **æ€§èƒ½ä¼˜å¼‚**ï¼š
- ç¼“å­˜å‘½ä¸­æ—¶: 400ms
- å¹³å‡é€Ÿåº¦: 800ms
- æ¯”æ— ç¼“å­˜å¿«3å€

âœ… **ç¨³å®šå¯é **ï¼š
- ç¼“å­˜ç©ºæ—¶è‡ªåŠ¨é™çº§
- è¿‡æœŸéªŒè¯è‡ªåŠ¨è·³è¿‡
- å¼‚æ­¥ä¸é˜»å¡

**ç›´æ¥ä½¿ç”¨å³å¯ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼**
