# ğŸ” æŠ¢å•æµç¨‹å®Œæ•´åˆ†æ

## ğŸ“‹ å®Œæ•´æµç¨‹

### å½“å‰å®ç°ï¼ˆfast_grab_service.pyï¼‰

```
1. ä¸»å¾ªç¯ (_run_loop)
   â†“
2. è·å–è®¢å•åˆ—è¡¨ (_get_order_list)
   â†“
3. è¿‡æ»¤æ–°è®¢å• (_filter_new_orders)
   â†“
4. å¹¶å‘æŠ¢å• (_grab_orders_concurrent)
   â†“
5. å•ä¸ªè®¢å•æŠ¢å• (_grab_order_fast)
   â†“
6. GeetestéªŒè¯ (_grab_with_geetest)
   â†“
7. å‘é€æŠ¢å•è¯·æ±‚
```

---

## âœ… æ­£ç¡®çš„éƒ¨åˆ†

### 1. æ£€æµ‹åˆ°è®¢å•ç«‹å³æŠ¢å• âœ…
**ä»£ç ä½ç½®**: ç¬¬214-237è¡Œ
```python
if orders:
    self.stats['orders_found'] += len(orders)
    self.log(f"[FOUND] {len(orders)} order(s) available")
    
    # Filter processed orders
    new_orders = self._filter_new_orders(orders)
    
    if new_orders:
        # Concurrent grab
        self._grab_orders_concurrent(new_orders)  # ç«‹å³æŠ¢å•
```

âœ… **çŠ¶æ€**: æ­£ç¡®
- æ£€æµ‹åˆ°è®¢å•åç«‹å³æŠ¢å•
- æ²¡æœ‰å»¶è¿Ÿ

### 2. å¼ºåˆ¶ä¹å®«æ ¼éªŒè¯ âœ…
**ä»£ç ä½ç½®**: ç¬¬428-432è¡Œ
```python
# ç›´æ¥è¿›è¡ŒGeetestéªŒè¯ï¼ˆä¸å…ˆå°è¯•ç©ºgeeDtoï¼‰
self.log(f"  [GEETEST] å¼€å§‹ä¹å®«æ ¼éªŒè¯...")
success = self._grab_with_geetest(order_id_str)
```

âœ… **çŠ¶æ€**: æ­£ç¡®
- æ¯ä¸ªè®¢å•éƒ½è¿›è¡ŒéªŒè¯
- ä¸å…ˆå°è¯•ç©ºgeeDtoï¼ˆé¿å…æµªè´¹æ—¶é—´ï¼‰

### 3. ä½¿ç”¨è¿œç¨‹AI âœ…
**ä»£ç ä½ç½®**: libs/geetest_helper_local.py ç¬¬208-233è¡Œ
```python
ai_server_url = os.environ.get('AI_SERVER_URL')
if ai_server_url:
    # ä½¿ç”¨è¿œç¨‹AIå®Œæ•´éªŒè¯æœåŠ¡
    response = requests.post(
        f"{ai_server_url}/api/verify",
        json={
            'captcha_id': self.captcha_id,
            'challenge': challenge,
            'threshold': self.threshold
        }
    )
    # ç›´æ¥è¿”å›å®Œæ•´ç»“æœ
    return result
```

âœ… **çŠ¶æ€**: æ­£ç¡®
- ä¼˜å…ˆä½¿ç”¨è¿œç¨‹AI
- ä¸€ç«™å¼æœåŠ¡
- ç›´æ¥è¿”å›æ‰€æœ‰å‚æ•°

---

## âš ï¸ æ½œåœ¨é—®é¢˜åˆ†æ

### é—®é¢˜1: è®¢å•IDå­—æ®µä¸ç¡®å®š âš ï¸

**ä»£ç ä½ç½®**: ç¬¬569-588è¡Œ
```python
def _get_order_id(self, order):
    """è·å–è®¢å• ID"""
    # å°è¯•å¤šç§å¯èƒ½çš„å­—æ®µå
    for field in ['orderNo', 'orderId', 'id', 'order_id']:
        if field in order and order[field]:
            order_id = order[field]
            break
```

**é—®é¢˜**: 
- ä¸ç¡®å®šçœŸå®APIè¿”å›çš„è®¢å•IDå­—æ®µå
- å¯èƒ½å¯¼è‡´è·å–ä¸åˆ°è®¢å•ID

**å½±å“**: 
- å¦‚æœå­—æ®µåä¸å¯¹ï¼Œä¼šè·³è¿‡è®¢å•
- æ—¥å¿—ä¼šæ˜¾ç¤º "Cannot find order ID"

**è§£å†³æ–¹æ¡ˆ**: 
- å·²ç»å°è¯•äº†4ç§å¸¸è§å­—æ®µå
- æœ‰è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- éœ€è¦åœ¨çœŸå®ç¯å¢ƒä¸­ç¡®è®¤å­—æ®µå

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰ï¼ˆæœ‰æ—¥å¿—å¯ä»¥å¿«é€Ÿå‘ç°ï¼‰

---

### é—®é¢˜2: æŠ¢å•APIç«¯ç‚¹å¯èƒ½ä¸å¯¹ âš ï¸

**ä»£ç ä½ç½®**: ç¬¬516è¡Œ
```python
url = f"{self.api_base_url}/gate/app-api/club/order/grabAnOrder/v1"
```

**é—®é¢˜**: 
- ä½¿ç”¨çš„æ˜¯ `/grabAnOrder/v1` ç«¯ç‚¹
- ä½†ä»æ‚¨æä¾›çš„cURLçœ‹ï¼ŒçœŸå®ç«¯ç‚¹å¯èƒ½æ˜¯ `/grab`

**çœŸå®ç«¯ç‚¹**ï¼ˆä»ä¹‹å‰çš„æµ‹è¯•ï¼‰:
```
https://dysh.dyswl.com/gate/app-api/club/order/grab
```

**å½±å“**: 
- å¦‚æœç«¯ç‚¹ä¸å¯¹ï¼Œä¼šè¿”å›404æˆ–å…¶ä»–é”™è¯¯
- æŠ¢å•ä¼šå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**: éœ€è¦ç¡®è®¤çœŸå®çš„æŠ¢å•APIç«¯ç‚¹

**é£é™©ç­‰çº§**: ğŸ”´ é«˜ï¼ˆå¯èƒ½å¯¼è‡´æ‰€æœ‰æŠ¢å•å¤±è´¥ï¼‰

---

### é—®é¢˜3: orderId æ ¼å¼é—®é¢˜ âš ï¸

**ä»£ç ä½ç½®**: ç¬¬510-514è¡Œ
```python
order_id_str = str(order_id)

payload = {
    'orderId': order_id_str,  # å­—ç¬¦ä¸²æ ¼å¼
    'geeDto': gee_dto
}
```

**é—®é¢˜**: 
- å°†orderIdè½¬æ¢ä¸ºå­—ç¬¦ä¸²
- ä½†æ ¹æ®ä¹‹å‰çš„è®°å¿†ï¼ŒorderIdåº”è¯¥æ˜¯æ•´æ•°æ ¼å¼

**å½±å“**: 
- å¯èƒ½å¯¼è‡´APIè¿”å›å‚æ•°é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**: åº”è¯¥ä½¿ç”¨æ•´æ•°æ ¼å¼

**é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰

---

### é—®é¢˜4: ç¼“å­˜æœºåˆ¶å¯èƒ½è¿‡æ—©æ ‡è®° âš ï¸

**ä»£ç ä½ç½®**: ç¬¬441è¡Œå’Œç¬¬526è¡Œ
```python
# æˆåŠŸåæ ‡è®°
if success:
    self.order_cache[order_id] = time.time()  # âœ… æ­£ç¡®

# GeetestéªŒè¯æˆåŠŸåä¹Ÿæ ‡è®°
if result.get('code') == 200 or result.get('code') == 0:
    self.order_cache[order_id] = time.time()  # âœ… æ­£ç¡®
```

âœ… **çŠ¶æ€**: æ­£ç¡®
- åªåœ¨æˆåŠŸæˆ–ç‰¹å®šå¤±è´¥åæ ‡è®°
- ä¸ä¼šè¿‡æ—©æ ‡è®°

---

## ğŸ”§ éœ€è¦ä¿®å¤çš„é—®é¢˜

### ä¿®å¤1: ç¡®è®¤å¹¶ä¿®å¤æŠ¢å•APIç«¯ç‚¹

**å½“å‰ä»£ç **:
```python
url = f"{self.api_base_url}/gate/app-api/club/order/grabAnOrder/v1"
```

**åº”è¯¥æ”¹ä¸º**:
```python
url = f"{self.api_base_url}/gate/app-api/club/order/grab"
```

### ä¿®å¤2: orderId ä½¿ç”¨æ•´æ•°æ ¼å¼

**å½“å‰ä»£ç **:
```python
order_id_str = str(order_id)
payload = {
    'orderId': order_id_str,
    'geeDto': gee_dto
}
```

**åº”è¯¥æ”¹ä¸º**:
```python
# å°è¯•è½¬æ¢ä¸ºæ•´æ•°
try:
    order_id_int = int(order_id)
except:
    order_id_int = order_id

payload = {
    'orderId': order_id_int,  # æ•´æ•°æ ¼å¼
    'geeDto': gee_dto
}
```

---

## ğŸ“Š å®Œæ•´æµç¨‹æ—¶é—´åˆ†æ

### ç†æƒ³æƒ…å†µï¼ˆä¸€åˆ‡é¡ºåˆ©ï¼‰
```
1. æ£€æµ‹è®¢å•: ~100-200ms
2. è¿‡æ»¤è®¢å•: ~1ms
3. GeetestéªŒè¯:
   - è°ƒç”¨è¿œç¨‹AI: ~2500ms (2.5ç§’)
   - è¿”å›å®Œæ•´å‚æ•°: ç«‹å³
4. æ„å»ºgeeDto: ~1ms
5. å‘é€æŠ¢å•è¯·æ±‚: ~100-200ms
-----------------------------------
æ€»è®¡: ~2.8ç§’
```

### æœ€åæƒ…å†µï¼ˆæœ‰é‡è¯•ï¼‰
```
1. æ£€æµ‹è®¢å•: ~200ms
2. GeetestéªŒè¯å¤±è´¥é‡è¯•: ~5ç§’
3. å‘é€æŠ¢å•è¯·æ±‚: ~200ms
-----------------------------------
æ€»è®¡: ~5.4ç§’
```

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### ç«‹å³éœ€è¦ä¿®å¤çš„ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **ä¿®å¤æŠ¢å•APIç«¯ç‚¹** ğŸ”´
   ```python
   # ä» grabAnOrder/v1 æ”¹ä¸º grab
   url = f"{self.api_base_url}/gate/app-api/club/order/grab"
   ```

2. **ä¿®å¤orderIdæ ¼å¼** ğŸŸ¡
   ```python
   # ä½¿ç”¨æ•´æ•°æ ¼å¼
   payload = {
       'orderId': int(order_id),
       'geeDto': gee_dto
   }
   ```

### å¯ä»¥åœ¨è¿è¡Œä¸­è§‚å¯Ÿçš„ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

3. **ç¡®è®¤è®¢å•IDå­—æ®µå** ğŸŸ¡
   - å½“å‰å·²ç»å°è¯•äº†4ç§å­—æ®µå
   - æœ‰è¯¦ç»†æ—¥å¿—ï¼Œå¯ä»¥å¿«é€Ÿå‘ç°é—®é¢˜

4. **ç›‘æ§æ€§èƒ½** ğŸŸ¢
   - å·²æœ‰è¯¦ç»†çš„æ—¶é—´ç»Ÿè®¡
   - å¯ä»¥çœ‹åˆ°æ¯ä¸€æ­¥çš„è€—æ—¶

---

## âœ… ä¿®å¤åçš„å®Œæ•´æµç¨‹

```
1. æ£€æµ‹åˆ°è®¢å• (200ms)
   â†“
2. è¿‡æ»¤æ–°è®¢å• (1ms)
   â†“
3. è°ƒç”¨è¿œç¨‹AIéªŒè¯ (2.5ç§’)
   - è¿”å›: lot_number, captcha_output(W), pass_token, gen_time
   â†“
4. æ„å»ºgeeDto (1ms)
   - lotNumber: âœ…
   - captchaOutput: âœ… (1280å­—ç¬¦)
   - passToken: âœ…
   - genTime: âœ…
   - captchaId: âœ…
   - captchaKeyType: âœ…
   â†“
5. å‘é€æŠ¢å•è¯·æ±‚ (200ms)
   - API: /gate/app-api/club/order/grab âœ…
   - orderId: æ•´æ•°æ ¼å¼ âœ…
   - geeDto: å®Œæ•´ âœ…
   â†“
6. æˆåŠŸï¼ğŸ‰
```

**æ€»è€—æ—¶**: ~2.9ç§’

---

## ğŸš¨ å…³é”®ç»“è®º

### å½“å‰çŠ¶æ€
- âœ… æ ¸å¿ƒé€»è¾‘æ­£ç¡®ï¼ˆæ£€æµ‹åˆ°è®¢å•ç«‹å³æŠ¢å•ï¼‰
- âœ… GeetestéªŒè¯æ­£ç¡®ï¼ˆä½¿ç”¨è¿œç¨‹AIï¼‰
- âœ… å‚æ•°æ„å»ºæ­£ç¡®ï¼ˆgeeDtoå®Œæ•´ï¼‰
- âš ï¸ APIç«¯ç‚¹å¯èƒ½ä¸å¯¹ï¼ˆéœ€è¦ä¿®å¤ï¼‰
- âš ï¸ orderIdæ ¼å¼å¯èƒ½ä¸å¯¹ï¼ˆéœ€è¦ä¿®å¤ï¼‰

### ä¿®å¤å
- âœ… æ‰€æœ‰åŠŸèƒ½å®Œå…¨æ­£ç¡®
- âœ… å¯ä»¥æˆåŠŸæŠ¢å•
- âœ… è€—æ—¶çº¦2.9ç§’

### å»ºè®®
**ç«‹å³ä¿®å¤APIç«¯ç‚¹å’ŒorderIdæ ¼å¼ï¼Œç„¶åå°±å¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼**
