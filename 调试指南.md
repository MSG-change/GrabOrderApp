# 🔍 调试指南 - 黑屏问题排查

## 📱 当前状态

**问题**：APP启动后显示黑屏，只有标题"抢单助手"可见

**可能原因**：
1. MainScreen初始化崩溃
2. UI构建失败
3. 模块导入错误
4. 字体加载失败
5. 权限请求阻塞

---

## 🔧 调试步骤

### 步骤1：查看系统日志

```bash
# 连接手机并查看日志
adb logcat | grep -i python

# 或者查看所有日志
adb logcat | grep -i "抢单助手\|GrabOrder\|python\|kivy"

# 保存日志到文件
adb logcat > debug.log
```

### 步骤2：查找关键错误

在日志中搜索以下关键词：

```
❌ - 错误信息
⚠️ - 警告信息
🔧 - 调试信息
✅ - 成功信息
```

### 步骤3：常见问题检查

#### 问题1：模块导入失败

**日志特征**：
```
⚠️ VPN服务导入失败: ...
⚠️ 抢单服务加载失败: ...
```

**解决方案**：
- 检查libs目录是否正确打包
- 确认所有依赖模块存在

#### 问题2：UI构建失败

**日志特征**：
```
❌ UI构建失败: ...
```

**解决方案**：
- 查看具体错误信息
- 可能是某个Widget创建失败

#### 问题3：字体加载失败

**日志特征**：
```
⚠️ 未找到字体文件，使用系统默认字体
```

**影响**：
- 中文可能显示为方块
- **不影响功能，只是显示问题**

#### 问题4：配置管理器失败

**日志特征**：
```
❌ 配置管理器初始化失败: ...
```

**解决方案**：
- 检查存储权限
- 检查配置文件路径

---

## 📋 调试版本特性

### 新增的调试功能

1. **详细日志输出**
   - 每个步骤都有print语句
   - 错误信息包含完整traceback
   - 使用分隔线清晰标识各个阶段

2. **安全错误处理**
   - 所有关键步骤都有try-except
   - 单个步骤失败不影响其他步骤
   - 即使UI构建失败也显示错误信息

3. **启动流程追踪**
   ```
   ==================================================
   🚀 抢单助手启动
   ==================================================
   🚀 GrabOrderApp.build() 开始
   🔧 设置窗口颜色...
   ✅ 窗口颜色设置完成
   🔧 注册中文字体...
   ✅ 字体注册完成
   🔧 请求Android权限...
   ✅ 权限请求完成
   🔧 创建MainScreen...
   🔧 MainScreen.__init__ 开始
   ✅ super().__init__ 完成
   ✅ 基础属性设置完成
   ✅ 日志缓冲初始化完成
   ✅ 配置管理器初始化成功
   🔧 开始构建UI...
   🔧 build_ui() 开始
   ...
   ```

---

## 🛠️ 快速调试命令

### 1. 实时查看日志

```bash
# 过滤Python相关日志
adb logcat | grep -E "python|Python|Kivy|GrabOrder"

# 查看所有错误
adb logcat *:E

# 清除日志缓存
adb logcat -c
```

### 2. 检查文件结构

```bash
# 检查APK内容（需要先解压）
unzip GrabOrder-*-debug.apk -d apk_content
find apk_content -name "*.py" | head -20
find apk_content -name "*.onnx" | head -20
find apk_content -name "*.ttf" | head -20
```

### 3. 检查权限

```bash
# 查看APP权限
adb shell dumpsys package com.graborder.graborder | grep permission

# 检查存储权限
adb shell run-as com.graborder.graborder ls -la
```

---

## 📊 日志分析示例

### 正常启动日志

```
==================================================
🚀 抢单助手启动
==================================================
Python版本: 3.9.15
工作目录: /data/user/0/com.graborder.graborder/files
Android模式: True
==================================================
✅ GrabOrderApp实例创建成功
🔧 开始运行应用...
==================================================
🚀 GrabOrderApp.build() 开始
==================================================
🔧 设置窗口颜色...
✅ 窗口颜色设置完成
🔧 注册中文字体...
🔤 开始注册中文字体...
   当前目录: /data/user/0/com.graborder.graborder/files
   __file__: /data/user/0/com.graborder.graborder/files/app/main.py
   尝试路径: fonts/DroidSansFallback.ttf (绝对路径: ...)
   ✅ 文件存在
✅ 中文字体加载成功: fonts/DroidSansFallback.ttf
✅ 字体注册完成
🔧 请求Android权限...
✅ 权限请求完成
🔧 创建MainScreen...
==================================================
🔧 MainScreen.__init__ 开始
==================================================
✅ super().__init__ 完成
✅ 基础属性设置完成
✅ 日志缓冲初始化完成
✅ 配置管理器初始化成功
🔧 开始构建UI...
🔧 build_ui() 开始
   创建标题...
   ✅ 标题添加完成
...
✅ UI构建完成
✅ MainScreen创建完成
==================================================
🎉 GrabOrderApp.build() 完成
==================================================
```

### 错误启动日志示例

```
==================================================
🚀 抢单助手启动
==================================================
...
🔧 创建MainScreen...
==================================================
🔧 MainScreen.__init__ 开始
==================================================
✅ super().__init__ 完成
...
❌ 配置管理器初始化失败: [Errno 13] Permission denied: '/data/user/0/com.graborder.graborder/files/config.json'
   Traceback (most recent call last):
   ...
⚠️ 配置管理器不可用
...
❌ UI构建失败: 'MainScreen' object has no attribute 'add_widget'
   Traceback (most recent call last):
   ...
```

---

## 🎯 下一步行动

1. **安装调试版本APK**
   - 下载最新的构建版本
   - 安装到手机

2. **查看日志**
   ```bash
   adb logcat -c  # 清除旧日志
   # 启动APP
   adb logcat | grep -E "🔧|✅|❌|⚠️"
   ```

3. **收集日志**
   ```bash
   adb logcat > debug_log.txt
   # 启动APP，等待5秒
   # 停止logcat (Ctrl+C)
   # 查看debug_log.txt
   ```

4. **发送日志**
   - 将日志文件发送给我
   - 或粘贴关键错误信息

---

## 💡 常见问题解决

### Q1: 日志中没有输出

**可能原因**：
- logcat过滤太严格
- Python print未输出到logcat

**解决方案**：
```bash
# 查看所有日志
adb logcat

# 或查看Kivy日志
adb logcat | grep Kivy
```

### Q2: 只有标题，没有UI

**可能原因**：
- build_ui()方法在标题之后崩溃
- 某个Widget创建失败

**检查方法**：
- 查看日志中的"build_ui()"相关信息
- 查找"创建标题"之后的错误

### Q3: 完全黑屏

**可能原因**：
- MainScreen创建失败
- build()方法返回None
- Kivy初始化失败

**检查方法**：
- 查看是否有"GrabOrderApp.build()"日志
- 检查是否有Kivy相关错误

---

## 📞 获取帮助

如果仍然无法解决，请提供：

1. **完整日志**（至少包含启动前30秒）
2. **错误截图**（如果有）
3. **手机型号和Android版本**
4. **APK版本号**

---

🎯 **现在请安装调试版本并查看日志，告诉我您看到了什么！**

