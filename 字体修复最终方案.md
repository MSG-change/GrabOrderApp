# 字体乱码修复最终方案

## 🎯 问题分析

应用在Android上显示中文乱码，原因是Kivy默认字体（Roboto）不支持中文字符。

## ✅ 解决方案

按照Kivy官方推荐的方法，使用 `resource_add_path` 和 `LabelBase.register` 来加载和注册中文字体。

## 📋 核心改动

### 1. 导入必要的模块

```python
from kivy.resources import resource_add_path
from kivy.core.text import LabelBase
from kivy.config import Config
```

### 2. 使用resource_add_path添加字体资源路径

```python
# 找到字体文件所在目录
font_dir = os.path.abspath('fonts')
font_filename = 'DroidSansFallback.ttf'

# 添加字体资源路径（关键步骤）
resource_add_path(font_dir)
```

### 3. 替换默认字体

```python
# 替换Kivy默认字体Roboto（关键步骤）
LabelBase.register('Roboto', font_filename)
```

### 4. 设置Kivy配置

```python
# 设置Kivy默认字体配置
Config.set('kivy', 'default_font', ['Roboto'])
```

## 🔧 实现细节

### Android环境字体加载流程

1. **首先尝试应用内字体**（优先级最高）
   - 查找 `fonts/DroidSansFallback.ttf`
   - 使用 `resource_add_path` 添加资源路径
   - 使用 `LabelBase.register('Roboto', 'DroidSansFallback.ttf')` 替换默认字体
   - 如果失败，尝试使用完整路径注册

2. **如果应用字体失败，尝试系统字体**
   - 查找 `/system/fonts/` 目录下的中文字体
   - 直接使用完整路径注册

3. **如果都失败，使用Kivy默认字体**
   - 记录警告日志
   - 应用仍然可以运行，只是可能显示乱码

### 关键代码位置

- **应用启动时预加载**：`main.py` 第1136-1223行
- **应用构建时加载**：`main.py` 第681-770行

## 📝 字体文件要求

- **文件名**：`DroidSansFallback.ttf`
- **位置**：`GrabOrderApp/fonts/DroidSansFallback.ttf`
- **状态**：✅ 已确认存在（298KB）

## 🎯 为什么这个方法有效

1. **`resource_add_path`**：告诉Kivy在哪里查找资源文件，这样可以使用相对路径引用字体
2. **`LabelBase.register('Roboto', ...)`**：替换Kivy默认字体Roboto，这样所有使用默认字体的Label都会自动使用中文字体
3. **不修改每个Label**：通过替换默认字体，所有Label自动支持中文，无需逐个修改

## ⚠️ 注意事项

1. **字体文件必须存在**：确保 `fonts/DroidSansFallback.ttf` 文件存在
2. **buildozer.spec配置**：确保 `.ttf` 文件被包含在APK中（已配置）
3. **资源路径**：使用 `resource_add_path` 后，可以使用文件名而不是完整路径

## 🔍 调试方法

如果仍然显示乱码，检查logcat日志：

```bash
./view_android_logs.sh | grep -i font
```

应该看到：
- `✅ 字体资源路径已添加`
- `✅ 默认字体已替换为: DroidSansFallback.ttf`
- `✅ 应用字体加载成功`

## 📚 参考

- Kivy官方文档：字体资源管理
- 用户提供的解决方案：使用 `resource_add_path` 和 `LabelBase.register`

