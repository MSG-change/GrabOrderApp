# æŠ¢å•æµ‹è¯•æŒ‡å—

## ğŸ¯ æµ‹è¯•ç›®æ ‡

å‘é€**çœŸå®çš„å®Œæ•´æŠ¢å•è¯·æ±‚**ï¼ŒéªŒè¯ï¼š
1. âœ… GeetestéªŒè¯æµç¨‹æ­£ç¡®
2. âœ… geeDtoå‚æ•°æ ¼å¼æ­£ç¡®
3. âœ… APIè¯·æ±‚æ ¼å¼æ­£ç¡®
4. âœ… è®¤è¯tokenæœ‰æ•ˆ
5. âœ… æ‰€æœ‰å‚æ•°ä¼ é€’æ­£ç¡®

å³ä½¿è®¢å•ä¸å­˜åœ¨ï¼ˆè¿”å›500ï¼‰ï¼Œä¹Ÿèƒ½ç¡®è®¤è¯·æ±‚æ ¼å¼æ˜¯æ­£ç¡®çš„ã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶

### 1. AIæœåŠ¡å™¨è¿è¡Œä¸­

```bash
# æ£€æŸ¥AIæœåŠ¡å™¨
curl http://127.0.0.1:8889/health

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨å®ƒ
cd ../geetest_ai
python3 api_server.py
```

### 2. è·å–ç™»å½•token

```bash
# è¿è¡Œç™»å½•æµ‹è¯•è·å–token
./run_login_test.sh

# è¾“å…¥æ‰‹æœºå·å’ŒçŸ­ä¿¡éªŒè¯ç 
# tokenä¼šè‡ªåŠ¨ä¿å­˜åˆ° login_token_<timestamp>.txt
```

## ğŸš€ è¿è¡Œæµ‹è¯•

### æ–¹å¼1: ä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
./run_grab_test.sh
```

### æ–¹å¼2: æ‰‹åŠ¨è¿è¡Œ

```bash
export AI_SERVER_URL=http://127.0.0.1:8889
python3 test_grab_order.py
```

## ğŸ“Š æµ‹è¯•æµç¨‹

### æ­¥éª¤1: è¾“å…¥è®¢å•ID

```
Enter order ID to test (default: 9999999): [è¾“å…¥æˆ–æŒ‰Enter]
```

å¯ä»¥ä½¿ç”¨ï¼š
- å‡è®¢å•IDï¼ˆå¦‚9999999ï¼‰- æµ‹è¯•å‚æ•°æ ¼å¼
- çœŸå®è®¢å•ID - æµ‹è¯•å®é™…æŠ¢å•

### æ­¥éª¤2: è‡ªåŠ¨æ‰§è¡Œ

ç¨‹åºä¼šè‡ªåŠ¨ï¼š
1. åŠ è½½tokenï¼ˆä»æ–‡ä»¶æˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰
2. åˆå§‹åŒ–Geetest
3. æ‰§è¡ŒGeetestéªŒè¯
4. æ„å»ºgeeDto
5. å‘é€æŠ¢å•è¯·æ±‚
6. åˆ†æå“åº”

### æ­¥éª¤3: æŸ¥çœ‹ç»“æœ

## ğŸ” é¢„æœŸå“åº”

### æƒ…å†µ1: è®¢å•ä¸å­˜åœ¨ï¼ˆæ­£å¸¸ï¼‰

```json
{
  "code": 500,
  "msg": "è®¢å•ä¸å­˜åœ¨"
}
```

**ç»“è®ºï¼š** âœ… å‚æ•°æ ¼å¼æ­£ç¡®ï¼APIæ¥å—äº†è¯·æ±‚ï¼Œåªæ˜¯è®¢å•ä¸å­˜åœ¨ã€‚

### æƒ…å†µ2: æŠ¢å•æˆåŠŸ

```json
{
  "code": 0,
  "msg": "success",
  "data": {...}
}
```

**ç»“è®ºï¼š** âœ… å®Œç¾ï¼çœŸçš„æŠ¢åˆ°å•äº†ï¼

### æƒ…å†µ3: éœ€è¦éªŒè¯ï¼ˆä¸åº”è¯¥å‡ºç°ï¼‰

```json
{
  "code": 1001,
  "msg": "éœ€è¦éªŒè¯"
}
```

**ç»“è®ºï¼š** âŒ Geetestå‚æ•°æœ‰é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥ã€‚

### æƒ…å†µ4: æœªæˆæƒ

```json
{
  "code": 401,
  "msg": "æœªæˆæƒ"
}
```

**ç»“è®ºï¼š** âŒ Tokenæ— æ•ˆæˆ–è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚

### æƒ…å†µ5: è®¢å•å·²è¢«æŠ¢

```json
{
  "code": 400,
  "msg": "è®¢å•å·²è¢«æŠ¢"
}
```

**ç»“è®ºï¼š** âœ… å‚æ•°æ­£ç¡®ï¼Œåªæ˜¯è®¢å•å·²ç»è¢«åˆ«äººæŠ¢äº†ã€‚

## ğŸ“ å®Œæ•´è¯·æ±‚ç¤ºä¾‹

### è¯·æ±‚

```http
POST /gate/app-api/club/order/grabAnOrder/v1 HTTP/1.1
Host: dysh.dyswl.com
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
User-Agent: Mozilla/5.0 (Linux; Android 12; ...)
tenant-id: 1

{
  "orderId": "9999999",
  "geeDto": {
    "lotNumber": "eeff14aab96541dcb41e23c7d63f4634",
    "captchaOutput": "8a799621b927af55cd8f6ce971d15c1d49bcd3c4...",
    "passToken": "7fa9861362a312958667a77999c1cc57c3a9a967...",
    "genTime": "1762714435",
    "captchaId": "045e2c229998a88721e32a763bc0f7b8",
    "captchaKeyType": "dlVerify"
  }
}
```

### å“åº”ï¼ˆè®¢å•ä¸å­˜åœ¨ï¼‰

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "code": 500,
  "msg": "è®¢å•ä¸å­˜åœ¨",
  "data": null
}
```

## âœ… æˆåŠŸæ ‡å‡†

æµ‹è¯•æˆåŠŸçš„æ ‡å¿—ï¼š

1. âœ… **GeetestéªŒè¯æˆåŠŸ**
   - Loadè¯·æ±‚æˆåŠŸ
   - AIè¯†åˆ«æˆåŠŸï¼ˆè¿”å›3ä¸ªç´¢å¼•ï¼‰
   - Verifyè¯·æ±‚æˆåŠŸ

2. âœ… **è¯·æ±‚å‘é€æˆåŠŸ**
   - HTTP 200å“åº”
   - è¿”å›JSONæ ¼å¼æ•°æ®

3. âœ… **å‚æ•°æ ¼å¼æ­£ç¡®**
   - Codeä¸æ˜¯1001ï¼ˆä¸æ˜¯"éœ€è¦éªŒè¯"ï¼‰
   - Codeä¸æ˜¯400ï¼ˆä¸æ˜¯å‚æ•°é”™è¯¯ï¼‰

4. âœ… **å¯æ¥å—çš„å“åº”**
   - Code 0/200: æŠ¢å•æˆåŠŸ
   - Code 500: è®¢å•ä¸å­˜åœ¨ï¼ˆæ­£å¸¸ï¼Œæµ‹è¯•ç”¨å‡IDï¼‰
   - Code 400: è®¢å•å·²è¢«æŠ¢ï¼ˆæ­£å¸¸ï¼ŒçœŸå®è®¢å•ï¼‰

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: Tokenæ— æ•ˆ

```
Response: {"code": 401, "msg": "æœªæˆæƒ"}
```

**è§£å†³ï¼š**
```bash
# é‡æ–°ç™»å½•è·å–æ–°token
./run_login_test.sh
```

### é—®é¢˜2: ä»ç„¶è¿”å›1001

```
Response: {"code": 1001, "msg": "éœ€è¦éªŒè¯"}
```

**æ£€æŸ¥ï¼š**
- geeDtoæ˜¯å¦å®Œæ•´
- lot_numberæ˜¯å¦æ­£ç¡®
- captchaOutputï¼ˆWå‚æ•°ï¼‰æ˜¯å¦æ­£ç¡®
- passTokenæ˜¯å¦æ­£ç¡®

### é—®é¢˜3: ç½‘ç»œè¶…æ—¶

```
Error: Read timed out
```

**è§£å†³ï¼š**
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æ£€æŸ¥APIæœåŠ¡å™¨æ˜¯å¦æ­£å¸¸
- å¢åŠ timeoutæ—¶é—´ï¼ˆå·²è®¾ç½®ä¸º30ç§’ï¼‰

### é—®é¢˜4: AIæœåŠ¡å™¨è¿æ¥å¤±è´¥

```
Error: Connection refused
```

**è§£å†³ï¼š**
```bash
cd ../geetest_ai
python3 api_server.py
```

## ğŸ“Š æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸçš„æµ‹è¯•æ—¥å¿—

```
[02:53:54] Testing Order Grab: 9999999
[02:53:54] Step 1: Performing Geetest verification...
[02:53:54] Challenge: 1af0c986e15506f0d2ac9230475bcced...
[02:53:55] Answers: [0, 1, 2]
[02:53:55] lot_number: eeff14aab96541dcb41e23c7d63f4634
[02:53:55] Geetest verification SUCCESS!

[02:53:55] Step 2: Building geeDto...
[02:53:55] geeDto structure:
[02:53:55]   lotNumber: eeff14aab96541dcb41e23c7d63f4634
[02:53:55]   captchaOutput: 8a799621b927af55cd8f6ce971d15c1d...
[02:53:55]   passToken: 7fa9861362a312958667a77999c1cc57...
[02:53:55]   genTime: 1762714435
[02:53:55]   captchaId: 045e2c229998a88721e32a763bc0f7b8
[02:53:55]   captchaKeyType: dlVerify

[02:53:55] Step 3: Sending grab request...
[02:53:55] Request URL: POST https://dysh.dyswl.com/gate/app-api/club/order/grabAnOrder/v1
[02:53:55] Payload structure:
[02:53:55]   orderId: 9999999 (type: str)
[02:53:55]   geeDto: ['lotNumber', 'captchaOutput', 'passToken', 'genTime', 'captchaId', 'captchaKeyType']

[02:53:56] Response: HTTP 200
[02:53:56] Result: {
  "code": 500,
  "msg": "è®¢å•ä¸å­˜åœ¨",
  "data": null
}

[02:53:56] ======================================================================
[02:53:56] Response Analysis:
[02:53:56] ======================================================================
[02:53:56] Code: 500
[02:53:56] Message: è®¢å•ä¸å­˜åœ¨

[02:53:56] âš ï¸  Expected: Order does not exist (testing with fake ID)
[02:53:56] âœ… PARAMETER TEST PASSED: API accepted the request format

======================================================================
Test Summary
======================================================================

âœ… Test PASSED

What this means:
  âœ… Geetest verification works
  âœ… geeDto structure is correct
  âœ… API accepts the request format
  âœ… Parameters are properly formatted

Ready for production use!
```

## ğŸ¯ æµ‹è¯•ç›®æ ‡è¾¾æˆ

å¦‚æœçœ‹åˆ°ä»¥ä¸Šæ—¥å¿—ï¼Œè¯´æ˜ï¼š

1. âœ… **Geetestæµç¨‹æ­£ç¡®**
   - Load â†’ è¯†åˆ« â†’ Verify å…¨éƒ¨æˆåŠŸ

2. âœ… **å‚æ•°æ ¼å¼æ­£ç¡®**
   - orderId: å­—ç¬¦ä¸²æ ¼å¼
   - geeDto: åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ

3. âœ… **APIæ¥å—è¯·æ±‚**
   - HTTP 200å“åº”
   - è¿”å›JSONæ•°æ®
   - Code 500åªæ˜¯å› ä¸ºè®¢å•ä¸å­˜åœ¨

4. âœ… **å¯ä»¥ç”¨äºç”Ÿäº§**
   - ç›¸åŒçš„é€»è¾‘å¯ä»¥ç”¨äºçœŸå®æŠ¢å•
   - åªéœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„è®¢å•ID

## ğŸš€ ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥ï¼š

1. **æµ‹è¯•çœŸå®è®¢å•**
   - ä½¿ç”¨çœŸå®çš„è®¢å•ID
   - éªŒè¯èƒ½å¦çœŸçš„æŠ¢åˆ°å•

2. **é›†æˆåˆ°APP**
   - å°†è¿™ä¸ªé€»è¾‘é›†æˆåˆ°æŠ¢å•æœåŠ¡
   - æ„å»ºAPKæµ‹è¯•

3. **æ€§èƒ½ä¼˜åŒ–**
   - å‡å°‘éªŒè¯æ—¶é—´
   - æé«˜æŠ¢å•æˆåŠŸç‡
